figure(1)
clf
cur_pos = get(gcf,'position');
cur_w = 400;
cur_h = 250;
set(gcf,'units','pixels','position',[cur_pos(1),cur_pos(2),cur_w,cur_h]);
hold on

n_cells = 5000000;
T = 5;

% experimentally observed single-cell doubling times
data_5c_high_v1=[			7.072916667		6		4.96875	6.989583333									16.1875	3.104166667	7.072916667	12.14583333		3.041666667	3.895833333	6.041666667	6.010416667			4.9375	3.041666667	2.958333333	3.895833333	7.020833333			11.16666667	3.104166667	3.895833333		15.0625	2.958333333											13.89583333			12.14583333			4.0625	7.020833333	10.04166667			3.041666667	3.041666667	4.03125	2.958333333	5.020833333	4.03125	4.041666667	2.0625	6.010416667	8.0625	5.895833333	7						11.02083333			2.958333333	3.104166667			3.041666667	4.03125		4.947916667	4.96875				8.979166667	4.916666667	2.958333333	4.0625	2.9375	4.96875	4.947916667						7.875	10.95833333	4.041666667		2.958333333	2.958333333				8.072916667	6.010416667	5.020833333	3.052083333				7.072916667						11.9375			7	12.02083333	4.947916667		6.041666667	4	17.0625	1.979166667	3.052083333	6.989583333	5.020833333	12.02083333	4.020833333	4.03125	4.947916667	2.041666667	8			3.979166667	1.916666667			8.072916667	14.02083333	8.072916667	3.104166667	2.958333333	7.020833333		7.875	4.916666667	11.02083333		4.020833333	6.041666667					4.041666667	2.958333333	2.958333333	5.020833333	3.895833333	3.104166667	2.104166667					11.0625		6	4.020833333					2.958333333	10.95833333	9.916666667					6.010416667	4.020833333	3.052083333	4.9375	4.96875	4.020833333	4.020833333	4.916666667			5.020833333	4.020833333	4.96875	12.02083333	7.072916667];
data_5c_high_v2=[1.916666667	3.052083333	4.947916667	4.020833333	12.89583333	8.916666667	6.041666667	6.010416667	12.02083333	4.03125	6.041666667	3.104166667	8.947916667	7.072916667	3.947916667					4.9375		4.020833333				8.072916667	5.020833333	4.947916667	2.9375	4.041666667		3.041666667	1.958333333					5.020833333	7.072916667	15.9375		11.95833333		3.104166667	8.916666667																16.1875	8.947916667	2.9375	8.916666667	4.916666667	1.979166667	2.958333333					2.9375	1.979166667	2.958333333			5.020833333	3.052083333						5.020833333	2.958333333	14.125				4.041666667	9	5.020833333			7.875	7.020833333		1.979166667	7.020833333	2.958333333								4.9375					5.020833333	4.03125										12.02083333	2.0625	2.958333333	4.03125				2.958333333	3.895833333								5.020833333	5.895833333	17.0625				7.020833333	2.958333333									4.03125	8.072916667	3.947916667	6.010416667	6.989583333		4.041666667	5.020833333	6.989583333	4.041666667	4.9375	6.041666667	3.979166667	4.96875			11.16666667	4.0625			7.072916667	3.041666667	5.020833333	4.0625	6.989583333	8.072916667			4.041666667		3.104166667	1.916666667	4.020833333	9		4.96875			4.020833333	4.916666667	4.03125	8.979166667		7.979166667	7.875	4.020833333	14.89583333	8.072916667		4.020833333			8.072916667	4.041666667		4.96875					11.9375	10.91666667	2.0625	4.020833333	4.020833333	9	4.916666667	7	7	5.020833333			3.104166667	4.020833333	4.020833333	4.020833333	9	3.104166667		2.104166667	4.96875	4.9375	4.020833333	7	8.947916667	5.895833333	6.041666667				1.979166667	2.958333333	5.947916667	6.041666667	14.02083333	7.072916667	3.979166667	2.958333333	6	5.895833333		4.020833333				5.895833333	7	7	2.958333333	7.072916667	4.03125	4.96875	5.947916667	3.947916667	4.166666667		4.96875		4.041666667	4.041666667	12.14583333	8.072916667];
data_5c_high_v3=[	2.9375	3.052083333	4.9375	6	2.104166667	4.96875	4.96875	4.96875	5.895833333	4.041666667	4.041666667	2.958333333	6.041666667	4	4.020833333	6.041666667			4.020833333		2.958333333	6.041666667	4.9375	4.0625	6.041666667	11.0625	4.020833333	8	4.03125			4.041666667	3.104166667	5.020833333	3.979166667	3.041666667	11.95833333	4.96875	5.895833333	5.895833333	4.9375	5.895833333	3.052083333	4.916666667	5.020833333			5.895833333	8.072916667	4.020833333	11.02083333	6.010416667	5.020833333	2.958333333				8.072916667	3.041666667	2.958333333	2.9375	9			1.979166667	1.916666667		7.020833333	6	7.875			5.020833333	6.041666667	8	2.9375	4.020833333	17.0625	17.0625	4.041666667	2.958333333	7			3.895833333	2.989583333	2.958333333			6	12.02083333	4.020833333	4.020833333	4.0625	6	3.979166667	4.020833333	8.947916667			4.041666667	8	2.0625		5.895833333	3.104166667	3.041666667	3.895833333	4.916666667	4.916666667	4.96875	4.03125			1.916666667	3.041666667	3.041666667	4.041666667	2.958333333	2.958333333	1.958333333	5.020833333	7				2.958333333	13.89583333	];

data_5c_lowGSH_v1=[3.049	1.840	2.090	1.840	1.840	1.951	3.188	3.188	2.833	2.833					2.090	2.090	2.090	3.028	1.896		1.840	3.257	2.090	2.833	3.257	3.257	4.250	4.146			1.840	2.090	1.840	2.090	2.090	2.833	1.840	4.250	2.833	1.951	2.194	1.097	2.194	4.250	1.931	1.951			3.049	3.049		3.028	3.188	3.188	2.833					0.882	1.951	3.257	3.257	1.840	1.951	1.840	1.840	2.833	1.951	3.028	2.833			1.840	6.146	5.208	2.833	1.951	1.840	3.931	2.833	1.951			1.951	2.833	5.208	2.833	2.833	1.840	3.257	2.701	1.840	1.840	1.951	2.194	4.056			4.125	1.840	2.833	2.833		4.056	1.840	2.090	3.028	2.090	2.160	2.833	2.833	1.951	1.951				1.840	2.833	2.194	1.896	3.931	5.028	1.840		4.056	5.153	2.833	2.194	3.028	3.049	3.049	4.146			1.951	4.125	2.090	3.028	1.840	1.840	3.764		];
data_5c_lowGSH_v2=[		2.833	1.840	2.194	1.840	3.188	3.049	2.833	2.833	5.153			3.049	2.160	1.840	1.840	2.194	4.250	3.188	3.028	1.840	2.090				3.049		2.833	2.090	2.090	6.090	2.090	2.833			3.931	3.188	4.056	1.840	1.840	2.833	3.049	2.090	3.049	3.049	6.076	2.194	2.160	1.896	2.090	3.049	3.028	3.028	2.958	1.931			4.146	2.833			1.840	2.090	4.056	3.188	2.833	2.833		3.049	2.194	2.833	2.090				1.951	1.951	3.257	2.090	2.090	4.250	2.160	1.951	1.840		1.896			3.049	2.160	4.250	1.896	3.188	2.958	2.833	2.194	0.882	1.951	1.951	2.194	0.868			2.833	4.125	3.028	3.931	2.833	3.257	3.257	3.257	2.194			2.090	1.951	3.931	3.931	1.840			3.931	3.931	3.049	3.049			1.840	6.146	3.028	3.188	2.833	1.840			1.951	2.833	1.951	2.194	2.160	3.188	3.257	3.931	1.840	3.188	2.090	2.160	5.028	2.090	4.146	1.951	1.931	6.090	1.840	1.896	1.931			1.951	1.951	3.257		4.125	2.160		3.049	2.833		2.160	1.951	2.090	3.028	4.125	2.090				1.840	2.833	2.090	2.090	4.056	1.840	1.951	2.090	4.146	2.090	2.833	2.090	1.951	4.146			3.049	2.160	2.833	3.257	5.153	3.028		];
data_5c_lowGSH_v3=[3.049	3.028	4.250	1.931	3.049	2.833	1.840	1.951	1.951	2.194	1.931	2.194	2.194	3.188	2.833	2.833	1.951	1.951	3.049			1.951	2.160		3.257	0.993	1.840	2.090	2.090	1.840	3.188	2.833	2.194	4.250	2.160	3.049			1.951		1.951					2.833	2.958	4.250	4.250	2.833	2.194	2.958	2.090	2.833		3.049	2.160	4.146	1.931	2.090			4.146	3.188		0.958	2.090	3.257	2.833		4.146	1.931	3.049	5.028	2.090	3.188	3.049	3.028	2.160	6.076	1.951	6.090	3.257		1.951	3.257	4.125			3.049	3.028	3.028	6.076	3.188	3.049	3.028	2.194			1.840	2.090	0.993	2.194	1.840	2.833	2.090	2.090	2.833		3.049			1.840	3.049	2.160	1.951	1.896	1.840	2.090		4.146	3.049	2.194	1.951	1.951			2.833	1.951	4.125	1.951	2.833	3.257		4.146	4.250	1.931	4.146	1.840	1.097	3.049	1.951	0.958	3.049	4.250	4.146	2.194			1.840	0.993	2.160	1.097	1.951	2.194	3.028	4.250	3.049	4.056	6.958				1.951	5.153			3.257			0.882	0.882	0.882	0.882	0.882	3.257	1.951			1.951	5.208	3.931			1.840	2.194	3.188	3.028];


% sample model without added GSH
ROS = 3.2;
[dtmin dtmin_samples dtdelay] = sample_times(T, ROS, n_cells);
Dtfull_contr = dtmin_samples+dtdelay;

% restrict data to duration of experimental timelapse
Dtfull_contr = (Dtfull_contr(Dtfull_contr<20));

% plot as histogram to get distribution
h1=histogram(Dtfull_contr,0:(1/20):20,'Normalization','Probability');
xval_contr = h1.BinEdges; xval_contr = xval_contr + (xval_contr(2)-xval_contr(1))/2; xval_contr = xval_contr(1:(end-1));
yval_contr = h1.Values;


% sample model with added GSH
ROS = 0.35;
[dtmin dtmin_samples dtdelay] = sample_times(T, ROS, n_cells);
Dtfull_gsh = dtmin_samples+dtdelay;

% restrict data to duration of experimental timelapse
Dtfull_gsh = (Dtfull_gsh(Dtfull_gsh<20));

% plot as histogram to get distribution
h1=histogram(Dtfull_gsh,0:(1/20):20,'Normalization','Probability');
xval_gsh = h1.BinEdges; xval_gsh = xval_gsh + (xval_gsh(2)-xval_gsh(1))/2; xval_gsh = xval_gsh(1:(end-1));
yval_gsh = h1.Values;


% remove histograms because we were just interested in the distribution
cla

% plot experimental data as histogram overlapped with model distribution, without added GSH
set(gca,'XLim',[0,20]);
h3=histogram([data_5c_high_v1 data_5c_high_v2 data_5c_high_v3],0.1+(-1:50)*1,'Normalization','probability', 'FaceColor',[0.0 0.4 0.8]);
plot(xval_contr(xval_contr>0 & xval_contr<20),20*yval_contr(xval_contr>0 & xval_contr<20),'-','LineWidth',2,'Color',[0.8 0.4 0.4]);

% plot experimental data as histogram overlapped with model distribution, with added GSH
h3=histogram([data_5c_lowGSH_v1 data_5c_lowGSH_v2 data_5c_lowGSH_v3],0.03+(-1:50)*1,'Normalization','probability','FaceColor',[0.4 0.8 0.4]);
plot(xval_gsh(xval_gsh>0 & xval_gsh<10),20*yval_gsh(xval_gsh>0 & xval_gsh<10),'-','LineWidth',2,'Color',[0.8 0.4 0.4]);

% figure layout
font_name = 'Arial';
font_size_tick = 14;
font_size_label = 14;
set(get(gca,'XAxis'),'FontSize', font_size_tick, 'FontName', font_name);
set(get(gca,'YAxis'),'FontSize', font_size_tick, 'FontName', font_name);
set(gca, 'Layer', 'top');
xlabel('Doubling time (days)', 'FontName', font_name, 'FontSize',font_size_label);
ylabel('% of cells', 'FontName', font_name, 'FontSize',font_size_label);
set(gca, 'TickLength', [0.025, 0.025]); 
set(gca, 'LineWidth', 1);
set(gca, 'YMinorTick','Off');
set(gca, 'XMinorTick','Off');
set(gca,'Ytick',[0 0.1 0.2 0.3 0.4]);
set(gca,'Xtick',[0 5 10 15 20 25 30]);
set(gca,'YtickLabel',{'0' '10' '20' '30' '40'});
set(gca,'YLim',[0 0.4]);



function [dtmin dtmin_samples dtdelay] = sample_times(T, R, n_cells)
	% model parameters
    tau_min_T0 = 2.5;
    Tm = -10;
    T0 = 5.02;
    k=0.77236;
    a = 120.72;
    rg_T0 = 11.23;
    
    % compute exact and sample minimum doubling time
    eps = normrnd(0,1,1,n_cells);
    dtmin = tau_min_T0 * exp( k*a * (1/(T-Tm) - 1/(T0-Tm)) );
    dtmin_samples = (tau_min_T0 + eps) * exp( k*a * (1/(T-Tm) - 1/(T0-Tm)) );
    
    % compute [ROS] dependent delay
    ROS = normrnd(R,1,1,n_cells);
    dtdelay = (1/rg_T0) * exp(a * (1/(T-Tm) - 1/(T0-Tm)) + ROS);
end